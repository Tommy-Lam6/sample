<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç¾ä»£æ™ºèƒ½ä¸­é†«ä¸­å¿ƒé ç´„ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap");
      body {
        font-family: "Noto Sans TC", sans-serif;
      }
      .step-indicator {
        transition: all 0.3s ease;
      }
      .service-card,
      .time-slot {
        transition: all 0.2s ease;
      }
      .service-card:hover {
        transform: translateY(-2px);
      }
      .time-slot:hover {
        transform: scale(1.02);
      }
      .fade-enter-active,
      .fade-leave-active {
        transition: opacity 0.5s;
      }
      .fade-enter,
      .fade-leave-to {
        opacity: 0;
      }
      .ai-chat-container {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      }
      .chat-message {
        max-width: 80%;
        word-wrap: break-word;
      }
      .user-message {
        margin-left: auto;
      }
      .ai-message {
        margin-right: auto;
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-slate-50 to-slate-100 text-slate-800">
    <div id="app" class="min-h-screen">
      <!-- ç™»å…¥é é¢ -->
      <div v-if="!currentMember" class="max-w-md mx-auto py-12 px-4">
        <div class="bg-white rounded-2xl shadow-lg p-8">
          <div class="text-center mb-8">
            <i class="fas fa-leaf text-emerald-500 text-5xl mb-4"></i>
            <h1 class="text-2xl font-bold text-emerald-700">
              ç¾ä»£æ™ºèƒ½ä¸­é†«ä¸­å¿ƒ
            </h1>
            <p class="text-slate-500 mt-2">æœƒå“¡ç™»å…¥ç³»çµ±</p>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2"
                >æ‰‹æ©Ÿè™Ÿç¢¼</label
              >
              <input
                type="tel"
                v-model="loginPhone"
                placeholder="è«‹è¼¸å…¥æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼"
                class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-500"
              />
            </div>
            <button
              @click="handleLogin"
              class="w-full bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition-colors font-medium"
            >
              ç™»å…¥ç³»çµ±
            </button>
            <div
              class="text-center text-sm text-slate-500 pt-4 border-t border-slate-200"
            >
              <p>ç¤ºç¯„å¸³è™Ÿï¼š0912-345-678 æˆ– 0933-456-789</p>
            </div>
          </div>
        </div>

        <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-white rounded-xl p-4 text-center shadow">
            <i class="fas fa-calendar-check text-emerald-500 text-2xl mb-2"></i>
            <h3 class="font-semibold text-emerald-700">æ™ºèƒ½é ç´„</h3>
            <p class="text-xs text-slate-500 mt-1">å³æ™‚æŸ¥çœ‹é†«å¸«èˆ‡åºŠä½ç‹€æ³</p>
          </div>
          <div class="bg-white rounded-xl p-4 text-center shadow">
            <i class="fab fa-whatsapp text-emerald-500 text-2xl mb-2"></i>
            <h3 class="font-semibold text-emerald-700">å³æ™‚é€šçŸ¥</h3>
            <p class="text-xs text-slate-500 mt-1">WhatsApp é ç´„ç¢ºèªèˆ‡æé†’</p>
          </div>
          <div class="bg-white rounded-xl p-4 text-center shadow">
            <i class="fas fa-robot text-emerald-500 text-2xl mb-2"></i>
            <h3 class="font-semibold text-emerald-700">AIå®¢æœ</h3>
            <p class="text-xs text-slate-500 mt-1">24å°æ™‚æ™ºèƒ½å®¢æœæ”¯æ´</p>
          </div>
        </div>
      </div>

      <!-- ä¸»ç³»çµ±é é¢ -->
      <div v-else class="max-w-7xl mx-auto px-4 py-6">
        <!-- é ‚éƒ¨å°èˆª -->
        <header
          class="flex flex-col md:flex-row justify-between items-center mb-8 pb-4 border-b border-slate-200"
        >
          <div class="flex items-center mb-4 md:mb-0">
            <i class="fas fa-leaf text-emerald-500 text-3xl mr-3"></i>
            <div>
              <h1 class="text-2xl font-bold text-emerald-700">
                ç¾ä»£æ™ºèƒ½ä¸­é†«ä¸­å¿ƒé ç´„ç³»çµ±
              </h1>
              <p class="text-sm text-slate-500">
                æ™ºæ…§é ç´„ Â· WhatsAppé€šçŸ¥ Â· AIæ™ºèƒ½å®¢æœ
              </p>
            </div>
          </div>

          <div class="flex flex-col md:flex-row items-center gap-4">
            <div class="bg-emerald-50 px-4 py-2 rounded-full">
              <span class="text-emerald-700 font-medium">
                <i class="fas fa-user-circle mr-2"></i>
                {{ currentMember.name }} ({{ currentMember.memberLevel }})
              </span>
            </div>
            <div class="flex gap-2">
              <button
                @click="setView('booking')"
                :class="view === 'booking' ? 'bg-emerald-600 text-white' : 'bg-slate-200'"
                class="px-4 py-2 rounded-lg transition-colors"
              >
                <i class="fas fa-calendar-plus mr-2"></i>é ç´„æœå‹™
              </button>
              <button
                @click="setView('myBookings')"
                :class="view === 'myBookings' ? 'bg-emerald-600 text-white' : 'bg-slate-200'"
                class="px-4 py-2 rounded-lg transition-colors"
              >
                <i class="fas fa-history mr-2"></i>æˆ‘çš„é ç´„
              </button>
              <button
                @click="setView('aiCustomerService')"
                :class="view === 'aiCustomerService' ? 'bg-emerald-600 text-white' : 'bg-slate-200'"
                class="px-4 py-2 rounded-lg transition-colors"
              >
                <i class="fas fa-robot mr-2"></i>AIå®¢æœ
              </button>
              <button
                @click="handleLogout"
                class="px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 transition-colors"
              >
                <i class="fas fa-sign-out-alt mr-2"></i>ç™»å‡º
              </button>
            </div>
          </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
          <section class="lg:col-span-2">
            <!-- AIå®¢æœé é¢ -->
            <div
              v-if="view === 'aiCustomerService'"
              class="bg-white rounded-2xl shadow-lg p-6"
            >
              <h2
                class="text-xl font-semibold mb-6 text-emerald-700 flex items-center"
              >
                <i class="fas fa-robot mr-2"></i>AIæ™ºèƒ½å®¢æœ
              </h2>

              <div class="ai-chat-container rounded-xl p-4 mb-4">
                <h3 class="font-semibold text-blue-700 mb-2 flex items-center">
                  <i class="fas fa-headset mr-2"></i>24å°æ™‚æ™ºèƒ½å®¢æœ
                </h3>
                <p class="text-sm text-blue-600 mb-3">
                  æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½ä¸­é†«AIå®¢æœï¼Œå¯ä»¥å”åŠ©æ‚¨è§£ç­”é ç´„ã€æœå‹™ã€é†«å¸«ç­‰ç›¸é—œå•é¡Œã€‚
                </p>
              </div>

              <!-- èŠå¤©å€åŸŸ -->
              <div class="mb-6">
                <div class="bg-slate-50 rounded-lg p-4 h-96 overflow-y-auto">
                  <div class="space-y-4">
                    <!-- AIæ­¡è¿è¨Šæ¯ -->
                    <div class="flex items-start">
                      <div
                        class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3 flex-shrink-0"
                      >
                        <i class="fas fa-robot text-blue-500"></i>
                      </div>
                      <div
                        class="ai-message bg-white rounded-2xl rounded-tl-none p-4 shadow-sm chat-message"
                      >
                        <p class="text-slate-700">
                          æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½ä¸­é†«AIå®¢æœï¼Œæœ‰ä»€éº¼å¯ä»¥å¹«æ‚¨çš„å—ï¼Ÿ
                        </p>
                      </div>
                    </div>

                    <!-- èŠå¤©è¨˜éŒ„ -->
                    <div
                      v-for="(msg, index) in chatMessages"
                      :key="index"
                      :class="msg.sender === 'user' ? 'justify-end' : 'justify-start'"
                      class="flex items-start"
                    >
                      <div
                        v-if="msg.sender === 'ai'"
                        class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3 flex-shrink-0"
                      >
                        <i class="fas fa-robot text-blue-500"></i>
                      </div>
                      <div
                        :class="msg.sender === 'user' ? 
                                'user-message bg-blue-500 text-white rounded-2xl rounded-tr-none' : 
                                'ai-message bg-white rounded-2xl rounded-tl-none'"
                        class="p-4 shadow-sm chat-message"
                      >
                        <p>{{ msg.text }}</p>
                      </div>
                      <div
                        v-if="msg.sender === 'user'"
                        class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center ml-3 flex-shrink-0"
                      >
                        <i class="fas fa-user text-white text-sm"></i>
                      </div>
                    </div>

                    <!-- AIå›è¦† -->
                    <div v-if="aiResponse" class="flex items-start">
                      <div
                        class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3 flex-shrink-0"
                      >
                        <i class="fas fa-robot text-blue-500"></i>
                      </div>
                      <div
                        class="ai-message bg-white rounded-2xl rounded-tl-none p-4 shadow-sm chat-message"
                      >
                        <p class="text-slate-700">{{ aiResponse }}</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- è¼¸å…¥å€åŸŸ -->
                <div class="mt-4">
                  <div class="flex space-x-2">
                    <input
                      type="text"
                      v-model="userMessage"
                      placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..."
                      class="flex-1 border border-slate-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      @keyup.enter="sendMessage"
                    />
                    <button
                      @click="sendMessage"
                      class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors"
                    >
                      <i class="fas fa-paper-plane"></i>
                    </button>
                  </div>

                  <!-- å¿«æ·å•é¡Œ -->
                  <div class="mt-3 flex flex-wrap gap-2">
                    <button
                      v-for="(question, index) in quickQuestions"
                      :key="index"
                      @click="selectQuickQuestion(question)"
                      class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1 rounded-full transition-colors"
                    >
                      {{ question }}
                    </button>
                  </div>
                </div>
              </div>

              <!-- å¸¸è¦‹å•é¡Œ -->
              <div>
                <h3 class="font-semibold text-slate-700 mb-3 flex items-center">
                  <i class="fas fa-question-circle mr-2 text-emerald-500"></i
                  >å¸¸è¦‹å•é¡Œ
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div
                    v-for="(faq, index) in faqs"
                    :key="index"
                    @click="selectQuickQuestion(faq.question)"
                    class="bg-slate-50 p-3 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors"
                  >
                    <div class="font-medium text-slate-700 text-sm">
                      {{ faq.question }}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- æˆ‘çš„é ç´„é é¢ -->
            <div
              v-if="view === 'myBookings'"
              class="bg-white rounded-2xl shadow-lg p-6"
            >
              <h2
                class="text-xl font-semibold mb-6 text-emerald-700 flex items-center"
              >
                <i class="fas fa-history mr-2"></i>æˆ‘çš„é ç´„è¨˜éŒ„
              </h2>

              <div
                v-if="myBookings.length === 0"
                class="text-center py-12 text-slate-500"
              >
                <i
                  class="fas fa-calendar-times text-4xl mb-4 text-slate-300"
                ></i>
                <p class="text-lg mb-4">å°šç„¡é ç´„è¨˜éŒ„</p>
                <button
                  @click="setView('booking')"
                  class="px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors"
                >
                  <i class="fas fa-calendar-plus mr-2"></i>ç«‹å³é ç´„
                </button>
              </div>

              <div v-else class="space-y-4">
                <div
                  v-for="booking in myBookings"
                  :key="booking.id"
                  class="border border-slate-200 rounded-xl p-4 hover:shadow-md transition-shadow"
                >
                  <div
                    class="flex flex-col md:flex-row justify-between items-start"
                  >
                    <div class="flex-1">
                      <div class="flex items-start">
                        <div
                          class="bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full text-sm font-medium mb-2"
                        >
                          {{ getService(booking.serviceId).name }}
                        </div>
                        <span
                          class="ml-2 bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs"
                        >
                          {{ getDoctor(booking.doctorId).specialty }}
                        </span>
                      </div>

                      <div class="flex flex-wrap gap-4 mt-2">
                        <div class="flex items-center text-slate-600">
                          <i class="fas fa-user-md mr-2 text-emerald-500"></i>
                          {{ getDoctor(booking.doctorId).name }}
                        </div>
                        <div class="flex items-center text-slate-600">
                          <i class="fas fa-clock mr-2 text-emerald-500"></i>
                          {{ formatDate(booking.start) }} {{
                          formatShort(booking.start) }}
                        </div>
                        <div class="flex items-center text-slate-600">
                          <i
                            class="fas fa-money-bill-wave mr-2 text-emerald-500"
                          ></i>
                          NT$ {{ getService(booking.serviceId).price }}
                        </div>
                      </div>

                      <div
                        v-if="booking.notes"
                        class="mt-3 p-3 bg-slate-50 rounded-lg"
                      >
                        <p class="text-sm text-slate-700">
                          <i
                            class="fas fa-sticky-note mr-2 text-emerald-500"
                          ></i>
                          {{ booking.notes }}
                        </p>
                      </div>
                    </div>

                    <div class="flex gap-2 mt-4 md:mt-0">
                      <button
                        @click="startEditBooking(booking)"
                        class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors"
                      >
                        <i class="fas fa-edit mr-1"></i>æ›´æ”¹
                      </button>
                      <button
                        @click="cancelBooking(booking.id)"
                        class="px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition-colors"
                      >
                        <i class="fas fa-times mr-1"></i>å–æ¶ˆ
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- é ç´„æµç¨‹ -->
            <div
              v-if="view === 'booking'"
              class="bg-white rounded-2xl shadow-lg p-6"
            >
              <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
              <div class="mb-8 flex justify-center">
                <div class="flex items-center gap-2 text-sm text-slate-500">
                  <div class="step-indicator flex flex-col items-center">
                    <span
                      :class="step >= 1 ? 'bg-emerald-600 text-white' : 'bg-slate-200'"
                      class="w-10 h-10 rounded-full flex items-center justify-center font-medium"
                    >
                      1
                    </span>
                    <span class="text-xs mt-1">é¸æœå‹™</span>
                  </div>
                  <div
                    class="w-12 h-1"
                    :class="step >= 2 ? 'bg-emerald-600' : 'bg-slate-200'"
                  ></div>
                  <div class="step-indicator flex flex-col items-center">
                    <span
                      :class="step >= 2 ? 'bg-emerald-600 text-white' : 'bg-slate-200'"
                      class="w-10 h-10 rounded-full flex items-center justify-center font-medium"
                    >
                      2
                    </span>
                    <span class="text-xs mt-1">é¸æ™‚é–“</span>
                  </div>
                  <div
                    class="w-12 h-1"
                    :class="step >= 3 ? 'bg-emerald-600' : 'bg-slate-200'"
                  ></div>
                  <div class="step-indicator flex flex-col items-center">
                    <span
                      :class="step >= 3 ? 'bg-emerald-600 text-white' : 'bg-slate-200'"
                      class="w-10 h-10 rounded-full flex items-center justify-center font-medium"
                    >
                      3
                    </span>
                    <span class="text-xs mt-1">è³‡æ–™</span>
                  </div>
                  <div
                    class="w-12 h-1"
                    :class="step === 4 ? 'bg-emerald-600' : 'bg-slate-200'"
                  ></div>
                  <div class="step-indicator flex flex-col items-center">
                    <span
                      :class="step === 4 ? 'bg-emerald-600 text-white' : 'bg-slate-200'"
                      class="w-10 h-10 rounded-full flex items-center justify-center font-medium"
                    >
                      <i class="fas fa-check"></i>
                    </span>
                    <span class="text-xs mt-1">å®Œæˆ</span>
                  </div>
                </div>
              </div>

              <!-- æ­¥é©Ÿ1: é¸æ“‡æœå‹™ -->
              <div v-if="step === 1">
                <h2
                  class="text-xl font-semibold mb-6 text-emerald-700 flex items-center"
                >
                  <i class="fas fa-concierge-bell mr-2"></i>è«‹é¸æ“‡æ²»ç™‚æœå‹™
                </h2>

                <!-- AIæ¨è–¦æç¤º -->
                <div
                  v-if="aiRecommendations.length > 0"
                  class="mb-6 p-4 ai-chat-container rounded-xl"
                >
                  <div class="flex items-center mb-2">
                    <i class="fas fa-robot text-blue-600 mr-2"></i>
                    <span class="font-medium text-blue-700"
                      >AIç‚ºæ‚¨æ¨è–¦ä»¥ä¸‹æœå‹™ï¼š</span
                    >
                  </div>
                  <div class="flex flex-wrap gap-2">
                    <button
                      v-for="service in aiRecommendations.slice(0, 2)"
                      :key="service.id"
                      @click="selectService(service.id)"
                      class="px-3 py-1 bg-white border border-blue-300 text-blue-700 rounded-full text-sm hover:bg-blue-50 transition-colors"
                    >
                      {{ service.name }}
                    </button>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div
                    v-for="service in SERVICES"
                    :key="service.id"
                    @click="selectService(service.id)"
                    :class="selectedService === service.id ? 
                                            'border-emerald-600 bg-emerald-50 ring-2 ring-emerald-300' : 
                                            'border-slate-200 hover:border-emerald-400'"
                    class="service-card border-2 rounded-xl p-5 cursor-pointer transition-all"
                  >
                    <div class="font-semibold text-lg mb-2">
                      {{ service.name }}
                    </div>
                    <div class="text-slate-600 text-sm mb-3">
                      {{ service.short }}
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-emerald-700 font-bold"
                        >NT$ {{ service.price }}</span
                      >
                      <span
                        class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded"
                      >
                        {{ service.duration }} åˆ†é˜
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- æ­¥é©Ÿ2: é¸æ“‡æ™‚é–“ -->
              <div v-if="step === 2">
                <h2
                  class="text-xl font-semibold mb-6 text-emerald-700 flex items-center"
                >
                  <i class="far fa-clock mr-2"></i>
                  {{ editingBooking ? 'ä¿®æ”¹é ç´„æ™‚é–“' : 'é¸æ“‡æ—¥æœŸã€æ™‚é–“èˆ‡é†«å¸«' }}
                </h2>

                <div
                  class="flex flex-col md:flex-row gap-4 items-start md:items-center mb-6 p-4 bg-slate-50 rounded-lg"
                >
                  <div class="flex-1">
                    <label class="block text-sm font-medium text-slate-700 mb-1"
                      >é ç´„æ—¥æœŸ</label
                    >
                    <input
                      type="date"
                      v-model="selectedDate"
                      class="w-full border border-slate-300 p-2 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                    />
                  </div>
                  <div class="flex-1">
                    <label class="block text-sm font-medium text-slate-700 mb-1"
                      >æŒ‡å®šé†«å¸«</label
                    >
                    <select
                      v-model="selectedDoctor"
                      class="w-full border border-slate-300 p-2 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                    >
                      <option value="any">ä»»ä½•å¯ç”¨é†«å¸«</option>
                      <option
                        v-for="doctor in DOCTORS"
                        :key="doctor.id"
                        :value="doctor.id"
                      >
                        {{ doctor.name }} - {{ doctor.specialty }}
                      </option>
                    </select>
                  </div>
                </div>

                <div class="mb-6">
                  <h3
                    class="text-lg font-medium text-slate-700 mb-3 flex items-center"
                  >
                    <i class="fas fa-calendar-day mr-2 text-emerald-500"></i
                    >å¯é ç´„æ™‚æ®µ
                  </h3>
                  <div
                    class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 max-h-96 overflow-y-auto p-2"
                  >
                    <div
                      v-for="slot in timeslots"
                      :key="slot.startIso"
                      @click="slot.available && setSelectedTime(slot)"
                      :class="[
                                            slot.available ? 
                                                'hover:bg-emerald-50 hover:border-emerald-400 cursor-pointer' : 
                                                'opacity-50 cursor-not-allowed',
                                            selectedTime?.startIso === slot.startIso ? 
                                                'ring-2 ring-emerald-300 bg-emerald-50 border-emerald-400' : 
                                                'border-slate-200'
                                        ]"
                      class="time-slot border rounded-lg p-3 text-center transition-all"
                    >
                      <div class="font-medium text-sm">
                        {{ formatShort(slot.startIso) }}
                      </div>
                      <div class="text-xs text-slate-500 mt-1">
                        {{ formatShort(slot.endIso) }}
                      </div>
                      <div
                        class="mt-2 text-xs font-medium"
                        :class="slot.available ? 'text-emerald-600' : 'text-red-500'"
                      >
                        {{ slot.available ? 'å¯é ç´„' : 'å·²æ»¿' }}
                      </div>
                    </div>
                  </div>
                </div>

                <div
                  class="flex justify-between items-center pt-4 border-t border-slate-200"
                >
                  <button
                    @click="editingBooking ? cancelEdit() : step = 1"
                    class="px-6 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 transition-colors flex items-center"
                  >
                    <i class="fas fa-arrow-left mr-2"></i>ä¸Šä¸€æ­¥
                  </button>
                  <button
                    @click="validateAndProceed"
                    :disabled="!selectedTime"
                    :class="selectedTime ? 
                                           'bg-emerald-600 hover:bg-emerald-700' : 
                                           'bg-slate-300 cursor-not-allowed'"
                    class="px-6 py-2 text-white rounded-lg transition-colors flex items-center"
                  >
                    {{ editingBooking ? 'ç¢ºèªä¿®æ”¹' : 'ä¸‹ä¸€æ­¥' }}
                    <i class="fas fa-arrow-right ml-2"></i>
                  </button>
                </div>
              </div>

              <!-- æ­¥é©Ÿ3: è¯çµ¡è³‡æ–™ -->
              <div v-if="step === 3">
                <h2
                  class="text-xl font-semibold mb-6 text-emerald-700 flex items-center"
                >
                  <i class="fas fa-user-edit mr-2"></i>ç¢ºèªè¯çµ¡è³‡æ–™
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1"
                      >å§“å</label
                    >
                    <input
                      v-model="customerName"
                      class="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1"
                      >é›»è©±</label
                    >
                    <input
                      v-model="customerPhone"
                      class="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                    />
                  </div>
                  <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-1"
                      >é›»å­éƒµä»¶</label
                    >
                    <input
                      v-model="customerEmail"
                      type="email"
                      class="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                    />
                  </div>
                  <div class="md:col-span-2">
                    <label
                      class="block text-sm font-medium text-slate-700 mb-1"
                    >
                      <i class="fas fa-sticky-note mr-2"></i
                      >å‚™è¨»ï¼ˆç—‡ç‹€æè¿°æˆ–ç‰¹æ®Šéœ€æ±‚ï¼‰
                    </label>
                    <textarea
                      v-model="customerNotes"
                      rows="3"
                      class="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                      placeholder="è«‹æè¿°æ‚¨çš„ä¸»è¦ç—‡ç‹€æˆ–ç‰¹æ®Šéœ€æ±‚..."
                    ></textarea>
                  </div>
                </div>

                <div
                  class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200"
                >
                  <label class="flex items-center cursor-pointer">
                    <input
                      type="checkbox"
                      v-model="sendWhatsApp"
                      class="mr-3 h-5 w-5 text-emerald-600 rounded focus:ring-emerald-500"
                    />
                    <div>
                      <span class="font-medium text-blue-800"
                        >ç™¼é€ WhatsApp é ç´„ç¢ºèªé€šçŸ¥</span
                      >
                      <p class="text-sm text-blue-600 mt-1">
                        æˆ‘å€‘å°‡é€é WhatsApp
                        ç™¼é€é ç´„ç¢ºèªè¨Šæ¯èˆ‡æé†’ï¼Œè®“æ‚¨ä¸æœƒéŒ¯éé ç´„æ™‚é–“ã€‚
                      </p>
                    </div>
                  </label>
                </div>

                <div
                  class="flex justify-between items-center pt-4 border-t border-slate-200"
                >
                  <button
                    @click="step = 2"
                    class="px-6 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 transition-colors flex items-center"
                  >
                    <i class="fas fa-arrow-left mr-2"></i>ä¸Šä¸€æ­¥
                  </button>
                  <button
                    @click="editingBooking ? updateBooking() : reserve()"
                    class="px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors flex items-center"
                  >
                    <i class="fas fa-calendar-check mr-2"></i>
                    {{ editingBooking ? 'ç¢ºèªä¿®æ”¹é ç´„' : 'ç¢ºèªé ç´„' }}
                  </button>
                </div>
              </div>

              <!-- æ­¥é©Ÿ4: å®Œæˆ -->
              <div v-if="step === 4" class="text-center py-8">
                <div
                  class="bg-emerald-50 border border-emerald-200 rounded-2xl p-8 max-w-md mx-auto"
                >
                  <div class="text-5xl text-emerald-500 mb-4">
                    <i class="fas fa-check-circle"></i>
                  </div>
                  <h2 class="text-2xl font-semibold text-emerald-700 mb-4">
                    é ç´„å®Œæˆï¼
                  </h2>
                  <p class="text-slate-700 mb-6 whitespace-pre-line">
                    {{ result?.msg }}
                  </p>

                  <div
                    v-if="sendWhatsApp"
                    class="mb-6 p-3 bg-green-50 rounded-lg border border-green-200"
                  >
                    <div
                      class="flex items-center justify-center text-green-700"
                    >
                      <i class="fab fa-whatsapp text-xl mr-2"></i>
                      <span class="font-medium"
                        >WhatsApp é€šçŸ¥å·²ç™¼é€è‡³æ‚¨çš„æ‰‹æ©Ÿ</span
                      >
                    </div>
                  </div>

                  <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <button
                      class="px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors flex items-center justify-center"
                      @click="resetBooking"
                    >
                      <i class="fas fa-plus-circle mr-2"></i>ç¹¼çºŒé ç´„
                    </button>
                    <button
                      class="px-6 py-3 bg-slate-200 rounded-lg hover:bg-slate-300 transition-colors flex items-center justify-center"
                      @click="setView('myBookings')"
                    >
                      <i class="fas fa-history mr-2"></i>æŸ¥çœ‹æˆ‘çš„é ç´„
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- å´é‚Šæ¬„ -->
          <aside class="space-y-6">
            <!-- å³æ™‚é ç´„ç‹€æ³ -->
            <div class="bg-white rounded-2xl shadow-lg p-5">
              <h3 class="font-semibold text-emerald-700 mb-4 flex items-center">
                <i class="fas fa-binoculars mr-2"></i>å³æ™‚é ç´„ç‹€æ³
              </h3>
              <div class="space-y-3">
                <div
                  v-for="booking in recentBookings"
                  :key="booking.id"
                  class="flex items-center p-3 bg-slate-50 rounded-lg"
                >
                  <div
                    class="flex-shrink-0 w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600"
                  >
                    <i class="fas fa-user-md"></i>
                  </div>
                  <div class="ml-3 flex-1">
                    <div class="font-medium text-sm">
                      {{ getDoctor(booking.doctorId).name }}
                    </div>
                    <div class="text-xs text-slate-500">
                      {{ getService(booking.serviceId).short }}
                    </div>
                  </div>
                  <div class="text-xs font-medium text-emerald-600">
                    {{ formatShort(booking.start) }}
                  </div>
                </div>
              </div>
            </div>

            <!-- è¨ºæ‰€æ¦‚æ³ -->
            <div class="bg-white rounded-2xl shadow-lg p-5">
              <h4 class="font-semibold text-emerald-700 mb-4 flex items-center">
                <i class="fas fa-clinic-medical mr-2"></i>è¨ºæ‰€æ¦‚æ³
              </h4>
              <div class="space-y-3">
                <div class="flex items-center p-3 bg-blue-50 rounded-lg">
                  <div
                    class="flex-shrink-0 w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"
                  >
                    <i class="fas fa-bed"></i>
                  </div>
                  <div class="ml-3">
                    <div class="font-medium">æ¨æ‹¿æ²»ç™‚åºŠ</div>
                    <div class="text-sm text-slate-600">
                      {{ TOTAL_BEDS.tuina }} å¼µå¯ç”¨
                    </div>
                  </div>
                </div>
                <div class="flex items-center p-3 bg-green-50 rounded-lg">
                  <div
                    class="flex-shrink-0 w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600"
                  >
                    <i class="fas fa-procedures"></i>
                  </div>
                  <div class="ml-3">
                    <div class="font-medium">é‡ç¸æ²»ç™‚åºŠ</div>
                    <div class="text-sm text-slate-600">
                      {{ TOTAL_BEDS.acup }} å¼µå¯ç”¨
                    </div>
                  </div>
                </div>
                <div class="flex items-center p-3 bg-purple-50 rounded-lg">
                  <div
                    class="flex-shrink-0 w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-600"
                  >
                    <i class="fas fa-user-md"></i>
                  </div>
                  <div class="ml-3">
                    <div class="font-medium">å°ˆæ¥­é†«å¸«</div>
                    <div class="text-sm text-slate-600">
                      {{ DOCTORS.length }} ä½æœå‹™ä¸­
                    </div>
                  </div>
                </div>
              </div>

              <div
                class="mt-4 p-3 bg-amber-50 rounded-lg border border-amber-200"
              >
                <p class="text-xs text-amber-700">
                  <i class="fas fa-lightbulb mr-1"></i>
                  <strong>ç³»çµ±ç‰¹è‰²ï¼š</strong><br />
                  â€¢ WhatsApp å³æ™‚é€šçŸ¥<br />
                  â€¢ æœƒå“¡å°ˆå±¬ç®¡ç†<br />
                  â€¢ ç·šä¸Šä¿®æ”¹é ç´„<br />
                  â€¢ æ™ºèƒ½åºŠä½åˆ†é…<br />
                  â€¢ AIæ™ºèƒ½å®¢æœæ”¯æ´
                </p>
              </div>
            </div>
          </aside>
        </main>

        <footer
          class="text-center text-sm text-slate-500 mt-8 pt-6 border-t border-slate-200"
        >
          <p>Â© 2025 æ™ºèƒ½ä¸­é†«è¨ºæ‰€é ç´„ç³»çµ± | æœå‹™å°ˆç·šï¼š02-1234-5678</p>
        </footer>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script>
      const { createApp, ref, computed, onMounted } = Vue;

      createApp({
        setup() {
          // è³‡æ–™å®šç¾©
          const DOCTORS = [
            { id: "d1", name: "é™³é†«å¸«", specialty: "æ¨æ‹¿å°ˆå®¶" },
            { id: "d2", name: "æé†«å¸«", specialty: "é‡ç¸å°ˆå®¶" },
            { id: "d3", name: "é»ƒé†«å¸«", specialty: "ç¶œåˆæ²»ç™‚" },
            { id: "d4", name: "ä½•é†«å¸«", specialty: "å…§ç§‘èª¿ç†" },
          ];

          const SERVICES = [
            {
              id: "s1",
              name: "æ¨æ‹¿æ²»ç™‚ï¼ˆ45 åˆ†é˜ï¼‰",
              short: "æ¨æ‹¿ 45m",
              bedType: "tuina",
              duration: 45,
              price: 600,
            },
            {
              id: "s2",
              name: "é‡ç¸æ²»ç™‚ï¼ˆ30 åˆ†é˜ï¼‰",
              short: "é‡ç¸ 30m",
              bedType: "acup",
              duration: 30,
              price: 500,
            },
            {
              id: "s3",
              name: "æ¨æ‹¿ + é‡ç¸ï¼ˆ60 åˆ†é˜ï¼‰",
              short: "æ¨ + é‡ 60m",
              bedType: "mixed",
              duration: 60,
              price: 1000,
            },
            {
              id: "s4",
              name: "æ–°ç—‡è«®è©¢ï¼ˆ30 åˆ†é˜ï¼‰",
              short: "æ–°ç—‡è«®è©¢ 30m",
              bedType: "none",
              duration: 30,
              price: 600,
            },
          ];

          const TOTAL_BEDS = { tuina: 5, acup: 5 };

          const MEMBERS = [
            {
              id: "m1",
              name: "å¼µä¸‰",
              phone: "0912-345-678",
              email: "zhang@example.com",
              memberLevel: "é»ƒé‡‘æœƒå“¡",
            },
            {
              id: "m2",
              name: "æå››",
              phone: "0933-456-789",
              email: "li@example.com",
              memberLevel: "ç™½éŠ€æœƒå“¡",
            },
          ];

          // åˆå§‹é ç´„è³‡æ–™
          const initialBookings = [
            {
              id: "b1",
              memberId: "m1",
              doctorId: "d1",
              serviceId: "s1",
              start: "2025-10-20T09:00:00",
              end: "2025-10-20T09:45:00",
              status: "confirmed",
              customerName: "å¼µä¸‰",
              customerPhone: "0912-345-678",
              customerEmail: "zhang@example.com",
              notes: "è‚©é ¸ç— ç—›",
            },
            {
              id: "b2",
              memberId: "m2",
              doctorId: "d2",
              serviceId: "s2",
              start: "2025-10-20T09:30:00",
              end: "2025-10-20T10:00:00",
              status: "confirmed",
              customerName: "æå››",
              customerPhone: "0933-456-789",
              customerEmail: "li@example.com",
              notes: "è…°ç—›æ²»ç™‚",
            },
            {
              id: "b3",
              memberId: "m1",
              doctorId: "d3",
              serviceId: "s3",
              start: "2025-10-20T14:00:00",
              end: "2025-10-20T15:00:00",
              status: "confirmed",
              customerName: "å¼µä¸‰",
              customerPhone: "0912-345-678",
              customerEmail: "zhang@example.com",
              notes: "é•·æœŸç–²å‹èª¿ç†",
            },
          ];

          // ç‹€æ…‹è®Šæ•¸
          const bookings = ref(initialBookings);
          const step = ref(0); // 0: ç™»å…¥, 1: é¸æœå‹™, 2: é¸æ™‚é–“, 3: è¯çµ¡è³‡æ–™, 4: å®Œæˆ
          const selectedService = ref(SERVICES[0].id);
          const selectedDoctor = ref("any");
          const selectedDate = ref("2025-10-20");
          const selectedTime = ref(null);
          const customerName = ref("");
          const customerPhone = ref("");
          const customerEmail = ref("");
          const customerNotes = ref("");
          const result = ref(null);
          const currentMember = ref(null);
          const view = ref("booking");
          const editingBooking = ref(null);
          const loginPhone = ref("");
          const sendWhatsApp = ref(true);

          // AIå®¢æœç›¸é—œè®Šæ•¸
          const userMessage = ref("");
          const chatMessages = ref([]);
          const aiResponse = ref("");
          const quickQuestions = ref([
            "å¦‚ä½•å–æ¶ˆé ç´„ï¼Ÿ",
            "ç‡Ÿæ¥­æ™‚é–“æ˜¯ï¼Ÿ",
            "æœ‰å“ªäº›æœå‹™é …ç›®ï¼Ÿ",
            "é†«å¸«å°ˆé•·æ˜¯ä»€éº¼ï¼Ÿ",
            "å¦‚ä½•æ›´æ”¹é ç´„æ™‚é–“ï¼Ÿ",
            "è¨ºæ‰€åœ°å€åœ¨å“ªè£¡ï¼Ÿ",
            "å¯ä»¥åˆ·å¡å—ï¼Ÿ",
          ]);

          const faqs = ref([
            { question: "å¦‚ä½•å–æ¶ˆé ç´„ï¼Ÿ" },
            { question: "ç‡Ÿæ¥­æ™‚é–“æ˜¯å¹¾é»åˆ°å¹¾é»ï¼Ÿ" },
            { question: "æœ‰å“ªäº›æœå‹™é …ç›®ï¼Ÿ" },
            { question: "é†«å¸«çš„å°ˆé•·æ˜¯ä»€éº¼ï¼Ÿ" },
            { question: "å¦‚ä½•æ›´æ”¹é ç´„æ™‚é–“ï¼Ÿ" },
            { question: "è¨ºæ‰€åœ°å€åœ¨å“ªè£¡ï¼Ÿ" },
            { question: "å¯ä»¥åˆ·å¡ä»˜æ¬¾å—ï¼Ÿ" },
            { question: "æœ‰åœè»Šå ´å—ï¼Ÿ" },
          ]);

          // AIæ¨è–¦è³‡æ–™
          const aiRecommendations = ref([
            {
              id: "s1",
              name: "æ¨æ‹¿æ²»ç™‚",
              reason: "æ ¹æ“šæ‚¨éå¾€çš„è‚©é ¸å•é¡Œ",
              icon: "fas fa-hands",
            },
            {
              id: "s3",
              name: "æ¨æ‹¿+é‡ç¸",
              reason: "é©åˆæ‚¨çš„ç¶œåˆç—‡ç‹€",
              icon: "fas fa-hand-holding-medical",
            },
          ]);

          // è¨ˆç®—å±¬æ€§
          const timeslots = computed(() => {
            const svc = SERVICES.find((s) => s.id === selectedService.value);
            const startDay = new Date(`${selectedDate.value}T09:00:00`);
            const endDay = new Date(`${selectedDate.value}T18:00:00`);
            const slots = [];

            for (
              let t = new Date(startDay);
              t < endDay;
              t.setMinutes(t.getMinutes() + 15)
            ) {
              const startIso = t.toISOString().slice(0, 16);
              const endIso = addMinutes(startIso, svc.duration);
              const overlap = bookings.value.filter(
                (b) =>
                  b.start < endIso &&
                  b.end > startIso &&
                  b.status !== "cancelled"
              );
              const doctorBusy =
                selectedDoctor.value !== "any" &&
                overlap.some((b) => b.doctorId === selectedDoctor.value);
              const available = overlap.length < 3 && !doctorBusy;
              slots.push({ startIso, endIso, available });
            }
            return slots;
          });

          const myBookings = computed(() => {
            return bookings.value.filter(
              (b) =>
                b.memberId === currentMember.value?.id &&
                b.status !== "cancelled"
            );
          });

          const recentBookings = computed(() => {
            return bookings.value
              .filter((b) => b.status !== "cancelled")
              .sort((a, b) => new Date(a.start) - new Date(b.start))
              .slice(0, 5);
          });

          // å·¥å…·å‡½æ•¸
          const addMinutes = (iso, mins) => {
            return new Date(new Date(iso).getTime() + mins * 60000)
              .toISOString()
              .slice(0, 16);
          };

          const formatShort = (dtIso) => {
            const d = new Date(dtIso);
            return d.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            });
          };

          const formatDate = (dtIso) => {
            const d = new Date(dtIso);
            return d.toLocaleDateString("zh-TW", {
              year: "numeric",
              month: "long",
              day: "numeric",
            });
          };

          const getService = (serviceId) => {
            return SERVICES.find((s) => s.id === serviceId);
          };

          const getDoctor = (doctorId) => {
            return DOCTORS.find((d) => d.id === doctorId);
          };

          // ç™»å…¥åŠŸèƒ½
          const handleLogin = () => {
            const member = MEMBERS.find((m) => m.phone === loginPhone.value);
            if (member) {
              currentMember.value = member;
              customerName.value = member.name;
              customerPhone.value = member.phone;
              customerEmail.value = member.email;
              step.value = 1;

              // æ¨¡æ“¬å¾APIç²å–AIæ¨è–¦
              generateAIRecommendations();
            } else {
              alert("æ‰¾ä¸åˆ°è©²é›»è©±è™Ÿç¢¼çš„æœƒå“¡ï¼Œè«‹ç¢ºèªæˆ–è¨»å†Šæ–°æœƒå“¡");
            }
          };

          // ç™»å‡ºåŠŸèƒ½
          const handleLogout = () => {
            currentMember.value = null;
            step.value = 0;
            loginPhone.value = "";
            view.value = "booking";
            resetBooking();
          };

          // è¨­å®šè¦–åœ–
          const setView = (newView) => {
            view.value = newView;
            if (newView === "booking") {
              resetBooking();
            }
          };

          // é¸æ“‡æœå‹™
          const selectService = (serviceId) => {
            selectedService.value = serviceId;
            step.value = 2;
          };

          // è¨­å®šé¸æ“‡æ™‚é–“
          const setSelectedTime = (slot) => {
            selectedTime.value = slot;
          };

          // é©—è­‰ä¸¦ç¹¼çºŒ
          const validateAndProceed = () => {
            if (!selectedTime.value) {
              alert("è«‹é¸æ“‡æ™‚æ®µ");
              return;
            }
            step.value = 3;
          };

          // æ¨¡æ“¬ç™¼é€ WhatsApp é€šçŸ¥
          const sendWhatsAppNotification = (booking) => {
            const service = SERVICES.find((s) => s.id === booking.serviceId);
            const doctor = DOCTORS.find((d) => d.id === booking.doctorId);
            const message = `ğŸ“… é ç´„ç¢ºèªé€šçŸ¥\n\nè¦ªæ„›çš„ ${
              booking.customerName
            }ï¼Œ\næ‚¨å·²æˆåŠŸé ç´„ ${formatDate(booking.start)} ${formatShort(
              booking.start
            )} çš„ ${service.name}ï¼Œç”± ${
              doctor.name
            } ç‚ºæ‚¨æœå‹™ã€‚\n\nğŸ“ ç¾ä»£æ™ºèƒ½ä¸­é†«ä¸­å¿ƒ\nğŸ“ æœå‹™å°ˆç·šï¼š02-1234-5678`;

            console.log("WhatsApp é€šçŸ¥å·²ç™¼é€:", message);
            alert(
              `ğŸ“± WhatsApp é€šçŸ¥å·²ç™¼é€è‡³ ${booking.customerPhone}\n\n${message}`
            );
          };

          // é ç´„åŠŸèƒ½
          const reserve = () => {
            if (!selectedTime.value) return alert("è«‹é¸æ“‡æ™‚æ®µ");
            const svc = SERVICES.find((s) => s.id === selectedService.value);
            const doctor =
              selectedDoctor.value === "any"
                ? DOCTORS[Math.floor(Math.random() * DOCTORS.length)].id
                : selectedDoctor.value;

            const newBooking = {
              id: "b" + (bookings.value.length + 1),
              memberId: currentMember.value?.id,
              doctorId: doctor,
              serviceId: svc.id,
              start: selectedTime.value.startIso,
              end: selectedTime.value.endIso,
              status: "confirmed",
              customerName: customerName.value,
              customerPhone: customerPhone.value,
              customerEmail: customerEmail.value,
              notes: customerNotes.value,
            };

            bookings.value.push(newBooking);

            if (sendWhatsApp.value) {
              sendWhatsAppNotification(newBooking);
            }

            result.value = {
              success: true,
              msg: `âœ… é ç´„æˆåŠŸï¼\n${svc.name}\né†«å¸«ï¼š${
                DOCTORS.find((d) => d.id === doctor).name
              }\næ™‚é–“ï¼š${formatDate(selectedTime.value.startIso)} ${formatShort(
                selectedTime.value.startIso
              )}`,
            };
            step.value = 4;
          };

          // å–æ¶ˆé ç´„
          const cancelBooking = (bookingId) => {
            if (confirm("ç¢ºå®šè¦å–æ¶ˆé€™å€‹é ç´„å—ï¼Ÿ")) {
              bookings.value = bookings.value.map((b) =>
                b.id === bookingId ? { ...b, status: "cancelled" } : b
              );
              alert("é ç´„å·²å–æ¶ˆ");
            }
          };

          // é–‹å§‹ä¿®æ”¹é ç´„
          const startEditBooking = (booking) => {
            editingBooking.value = booking;
            selectedService.value = booking.serviceId;
            selectedDoctor.value = booking.doctorId;
            selectedDate.value = booking.start.slice(0, 10);
            view.value = "booking";
            step.value = 2;
          };

          // å–æ¶ˆç·¨è¼¯
          const cancelEdit = () => {
            editingBooking.value = null;
            resetBooking();
            view.value = "myBookings";
          };

          // æ›´æ–°é ç´„
          const updateBooking = () => {
            if (!selectedTime.value) return alert("è«‹é¸æ“‡æ™‚æ®µ");
            const svc = SERVICES.find((s) => s.id === selectedService.value);
            const doctor =
              selectedDoctor.value === "any"
                ? DOCTORS[Math.floor(Math.random() * DOCTORS.length)].id
                : selectedDoctor.value;

            bookings.value = bookings.value.map((b) =>
              b.id === editingBooking.value.id
                ? {
                    ...b,
                    doctorId: doctor,
                    serviceId: svc.id,
                    start: selectedTime.value.startIso,
                    end: selectedTime.value.endIso,
                    customerName: customerName.value,
                    customerPhone: customerPhone.value,
                    customerEmail: customerEmail.value,
                    notes: customerNotes.value,
                  }
                : b
            );

            if (sendWhatsApp.value) {
              sendWhatsAppNotification({
                ...editingBooking.value,
                doctorId: doctor,
                serviceId: svc.id,
                start: selectedTime.value.startIso,
                end: selectedTime.value.endIso,
                customerName: customerName.value,
                customerPhone: customerPhone.value,
              });
            }

            result.value = {
              success: true,
              msg: `âœ… é ç´„å·²æ›´æ–°ï¼\n${svc.name}\né†«å¸«ï¼š${
                DOCTORS.find((d) => d.id === doctor).name
              }\næ™‚é–“ï¼š${formatDate(selectedTime.value.startIso)} ${formatShort(
                selectedTime.value.startIso
              )}`,
            };
            editingBooking.value = null;
            step.value = 4;
          };

          // é‡ç½®é ç´„è¡¨å–®
          const resetBooking = () => {
            step.value = 1;
            selectedService.value = SERVICES[0].id;
            selectedDoctor.value = "any";
            selectedDate.value = "2025-10-20";
            selectedTime.value = null;
            customerNotes.value = "";
            result.value = null;
            editingBooking.value = null;

            // ä¿ç•™æœƒå“¡è³‡æ–™
            if (currentMember.value) {
              customerName.value = currentMember.value.name;
              customerPhone.value = currentMember.value.phone;
              customerEmail.value = currentMember.value.email;
            }
          };

          // AIå®¢æœåŠŸèƒ½
          const sendMessage = () => {
            if (!userMessage.value.trim()) return;

            // æ·»åŠ ç”¨æˆ¶è¨Šæ¯åˆ°èŠå¤©è¨˜éŒ„
            chatMessages.value.push({
              sender: "user",
              text: userMessage.value,
            });

            // æ¨¡æ“¬AIå›è¦†ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­é€™è£¡æ‡‰è©²èª¿ç”¨AI APIï¼‰
            setTimeout(() => {
              const responses = {
                "å¦‚ä½•å–æ¶ˆé ç´„ï¼Ÿ":
                  "æ‚¨å¯ä»¥åœ¨ã€æˆ‘çš„é ç´„ã€é é¢ä¸­æ‰¾åˆ°è¦å–æ¶ˆçš„é ç´„ï¼Œé»æ“Šå–æ¶ˆæŒ‰éˆ•å³å¯ã€‚å–æ¶ˆé ç´„è«‹è‡³å°‘æå‰2å°æ™‚é€šçŸ¥æˆ‘å€‘ã€‚",
                "ç‡Ÿæ¥­æ™‚é–“æ˜¯ï¼Ÿ":
                  "æˆ‘å€‘çš„ç‡Ÿæ¥­æ™‚é–“æ˜¯é€±ä¸€è‡³é€±äº” 9:00-18:00ï¼Œé€±å…­ 9:00-12:00ï¼Œé€±æ—¥åŠåœ‹å®šå‡æ—¥ä¼‘æ¯ã€‚",
                "æœ‰å“ªäº›æœå‹™é …ç›®ï¼Ÿ":
                  "æˆ‘å€‘æä¾›æ¨æ‹¿æ²»ç™‚ã€é‡ç¸æ²»ç™‚ã€æ¨æ‹¿+é‡ç¸ç¶œåˆæ²»ç™‚ä»¥åŠæ–°ç—‡è«®è©¢æœå‹™ã€‚è©³ç´°å…§å®¹è«‹åƒè€ƒé ç´„é é¢ã€‚",
                "é†«å¸«å°ˆé•·æ˜¯ä»€éº¼ï¼Ÿ":
                  "é™³é†«å¸«å°ˆé•·æ¨æ‹¿ï¼Œæé†«å¸«å°ˆé•·é‡ç¸ï¼Œé»ƒé†«å¸«å°ˆé•·ç¶œåˆæ²»ç™‚ï¼Œä½•é†«å¸«å°ˆé•·å…§ç§‘èª¿ç†ã€‚æ‚¨å¯ä»¥åœ¨é ç´„æ™‚é¸æ“‡é©åˆçš„é†«å¸«ã€‚",
                "å¦‚ä½•æ›´æ”¹é ç´„æ™‚é–“ï¼Ÿ":
                  "åœ¨ã€æˆ‘çš„é ç´„ã€é é¢é»æ“Šã€æ›´æ”¹ã€æŒ‰éˆ•ï¼Œå³å¯é‡æ–°é¸æ“‡æ™‚é–“å’Œé†«å¸«ã€‚",
                "è¨ºæ‰€åœ°å€åœ¨å“ªè£¡ï¼Ÿ":
                  "æˆ‘å€‘çš„åœ°å€æ˜¯å°åŒ—å¸‚å¤§å®‰å€å¿ å­æ±è·¯å››æ®µ123è™Ÿ5æ¨“ï¼Œè¿‘å¿ å­å¾©èˆˆæ·é‹ç«™ã€‚",
                "å¯ä»¥åˆ·å¡å—ï¼Ÿ": "å¯ä»¥çš„ï¼æˆ‘å€‘æ¥å—ç¾é‡‘ã€ä¿¡ç”¨å¡åŠè¡Œå‹•æ”¯ä»˜ã€‚",
                "æœ‰åœè»Šå ´å—ï¼Ÿ": "è¨ºæ‰€é™„è¿‘æœ‰ä»˜è²»åœè»Šå ´ï¼Œæ­¥è¡Œç´„3-5åˆ†é˜ã€‚",
              };

              // é è¨­å›è¦†
              let response =
                "æ„Ÿè¬æ‚¨çš„æå•ï¼å¦‚éœ€æ›´è©³ç´°çš„è³‡è¨Šï¼Œè«‹è‡´é›»æˆ‘å€‘çš„æœå‹™å°ˆç·šï¼š02-1234-5678";

              // é—œéµè©åŒ¹é…
              const userQuestion = userMessage.value.toLowerCase();
              for (const [key, value] of Object.entries(responses)) {
                if (
                  userQuestion.includes(key.replace("ï¼Ÿ", "").toLowerCase())
                ) {
                  response = value;
                  break;
                }
              }

              aiResponse.value = response;

              // æ¸…ç©ºè¼¸å…¥æ¡†
              userMessage.value = "";
            }, 1000);
          };

          // é¸æ“‡å¿«æ·å•é¡Œ
          const selectQuickQuestion = (question) => {
            userMessage.value = question;
            sendMessage();
          };

          // AIåŠŸèƒ½
          const generateAIRecommendations = () => {
            // æ¨¡æ“¬å¾APIç²å–AIæ¨è–¦
            // é€™è£¡å¯ä»¥æ ¹æ“šæœƒå“¡çš„é ç´„æ­·å²ã€ç—‡ç‹€æè¿°ç­‰ç”Ÿæˆæ¨è–¦
            setTimeout(() => {
              aiRecommendations.value = [
                {
                  id: "s1",
                  name: "æ¨æ‹¿æ²»ç™‚",
                  reason: "æ ¹æ“šæ‚¨éå¾€çš„è‚©é ¸å•é¡Œ",
                  icon: "fas fa-hands",
                },
                {
                  id: "s3",
                  name: "æ¨æ‹¿+é‡ç¸",
                  reason: "é©åˆæ‚¨çš„ç¶œåˆç—‡ç‹€",
                  icon: "fas fa-hand-holding-medical",
                },
              ];
            }, 500);
          };

          // åˆå§‹åŒ–
          onMounted(() => {
            // è¨­ç½®é è¨­å€¼
            selectedDate.value = new Date().toISOString().slice(0, 10);
          });

          return {
            DOCTORS,
            SERVICES,
            TOTAL_BEDS,
            MEMBERS,
            bookings,
            step,
            selectedService,
            selectedDoctor,
            selectedDate,
            selectedTime,
            customerName,
            customerPhone,
            customerEmail,
            customerNotes,
            result,
            currentMember,
            view,
            editingBooking,
            loginPhone,
            sendWhatsApp,
            userMessage,
            chatMessages,
            aiResponse,
            quickQuestions,
            faqs,
            aiRecommendations,
            timeslots,
            myBookings,
            recentBookings,
            handleLogin,
            handleLogout,
            setView,
            selectService,
            setSelectedTime,
            validateAndProceed,
            reserve,
            cancelBooking,
            startEditBooking,
            cancelEdit,
            updateBooking,
            resetBooking,
            sendMessage,
            selectQuickQuestion,
            addMinutes,
            formatShort,
            formatDate,
            getService,
            getDoctor,
            sendWhatsAppNotification,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
